<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Job Search Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 40px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #f87171;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #60a5fa;
        }

        .hidden {
            display: none;
        }

        .file-upload-zone {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-zone:hover {
            background: #eff1ff;
            border-color: #764ba2;
        }

        .match-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 18px;
            margin: 16px 0;
        }

        .match-excellent {
            background: #d1fae5;
            color: #065f46;
        }

        .match-good {
            background: #dbeafe;
            color: #1e40af;
        }

        .match-fair {
            background: #fef3c7;
            color: #92400e;
        }

        .match-poor {
            background: #fee2e2;
            color: #991b1b;
        }

        .document-output {
            background: #f9fafb;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 24px;
            margin-top: 24px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .nav-buttons button {
            flex: 0 0 auto;
            min-width: 120px;
        }

        .generated-files-list {
            background: #f9fafb;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 24px;
        }

        .generated-file-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .file-meta {
            font-size: 12px;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .file-actions button {
            padding: 8px 16px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ AI Job Search Assistant</h1>
            <p>Smart job matching with AI-powered resume and cover letter generation</p>
        </div>

        <div class="content">
            <!-- Setup Section -->
            <div id="setup-section" class="section active">
                <h2>Profile Setup</h2>
                <p style="margin: 16px 0; color: #666;">Choose how you'd like to set up your profile:</p>
                
                <div class="button-group">
                    <button class="btn-primary" onclick="showManualEntry()">Manual Entry</button>
                    <button class="btn-secondary" onclick="showDocumentUpload()">Upload Documents</button>
                </div>

                <!-- Manual Entry Form -->
                <div id="manual-entry-form" class="hidden" style="margin-top: 32px;">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="name" required>
                    </div>

                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="email" required>
                    </div>

                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="phone">
                    </div>

                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="location" placeholder="City, State">
                    </div>

                    <div class="form-group">
                        <label>LinkedIn Profile</label>
                        <input type="url" id="linkedin" placeholder="https://linkedin.com/in/yourname">
                    </div>

                    <div class="form-group">
                        <label>Work Experience</label>
                        <textarea id="experience" placeholder="List your relevant work experience..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Skills</label>
                        <textarea id="skills" placeholder="List your key skills..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Education</label>
                        <textarea id="education" placeholder="Your educational background..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Certifications</label>
                        <textarea id="certifications" placeholder="Any relevant certifications..."></textarea>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" onclick="showSection('setup-section'); hideManualEntry()">Back</button>
                        <button class="btn-primary" onclick="saveManualProfile()">Save Profile</button>
                    </div>
                </div>

                <!-- Document Upload Form -->
                <div id="document-upload-form" class="hidden" style="margin-top: 32px;">
                    <div class="file-upload-zone" onclick="document.getElementById('file-input').click()">
                        <p style="font-size: 48px; margin-bottom: 16px;">üìÑ</p>
                        <p style="font-weight: 600; margin-bottom: 8px;">Click to upload your resume/CV</p>
                        <p style="font-size: 14px; color: #666;">Supports PDF, DOCX, or TXT files</p>
                        <input type="file" id="file-input" accept=".pdf,.docx,.txt" multiple style="display: none;" onchange="handleFileUpload(event)">
                    </div>
                    <div id="upload-status" class="hidden"></div>
                    <div class="button-group" style="margin-top: 24px;">
                        <button class="btn-secondary" onclick="showSection('setup-section'); hideDocumentUpload()">Back</button>
                    </div>
                </div>
            </div>

            <!-- Review Section -->
            <div id="review-section" class="section">
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="showSection('setup-section')">‚Üê Back to Setup</button>
                </div>
                
                <h2>Review Your Profile</h2>
                <p style="margin: 16px 0; color: #666;">Please review and edit if needed:</p>
                
                <div id="profile-review"></div>
                
                <div class="button-group">
                    <button class="btn-secondary" onclick="editProfile()">Edit Profile</button>
                    <button class="btn-danger" onclick="startOver()">Start Over</button>
                    <button class="btn-primary" onclick="confirmProfile()">Confirm & Continue</button>
                </div>
            </div>

            <!-- Job Analysis Section -->
            <div id="job-analysis-section" class="section">
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="showSection('review-section')">‚Üê Back to Profile</button>
                    <button class="btn-secondary" onclick="showGeneratedFiles()">üìÅ View Generated Files</button>
                </div>
                
                <h2>Analyze a Job Posting</h2>
                <p style="margin: 16px 0; color: #666;">Paste the job description or share the URL with me in chat:</p>
                
                <div class="form-group">
                    <label>Job Description</label>
                    <textarea id="job-description" placeholder="Paste the full job description here..." style="min-height: 200px;"></textarea>
                </div>

                <div class="alert alert-info">
                    <strong>üí° Tip:</strong> If you have a job posting URL, share it with me in the chat and I'll fetch the full description for you!
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="analyzeJob()">Analyze Job Match</button>
                </div>

                <div id="analysis-result" class="hidden"></div>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="section">
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="showSection('job-analysis-section')">‚Üê Back to Job Analysis</button>
                    <button class="btn-secondary" onclick="showGeneratedFiles()">üìÅ View Generated Files</button>
                </div>
                
                <div id="results-content"></div>
            </div>

            <!-- Generated Files Section -->
            <div id="generated-files-section" class="section">
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="returnToPreviousSection()">‚Üê Back</button>
                </div>
                
                <h2>Generated Files</h2>
                <p style="margin: 16px 0; color: #666;">All your generated resumes and cover letters:</p>
                
                <div id="files-list" class="generated-files-list">
                    <p style="color: #666; text-align: center;">No files generated yet.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize storage
        let profileData = null;
        let currentJobDescription = null;
        let currentAnalysis = null;
        let previousSection = null;
        let generatedFiles = [];

        // Load saved data
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // Load profile
                const savedProfile = await window.storage.get('job-assistant-profile');
                if (savedProfile) {
                    profileData = JSON.parse(savedProfile.value);
                    showSection('job-analysis-section');
                }

                // Load generated files
                const savedFiles = await window.storage.get('job-assistant-files');
                if (savedFiles) {
                    generatedFiles = JSON.parse(savedFiles.value);
                }
            } catch (error) {
                console.log('No saved data found');
            }
        });

        // Save generated files to storage
        async function saveGeneratedFiles() {
            try {
                await window.storage.set('job-assistant-files', JSON.stringify(generatedFiles));
            } catch (error) {
                console.error('Error saving files:', error);
            }
        }

        // Add file to generated files list
        function addGeneratedFile(type, jobTitle, content) {
            const file = {
                id: Date.now(),
                type: type, // 'resume' or 'coverLetter'
                jobTitle: jobTitle,
                content: content,
                timestamp: new Date().toISOString(),
                dateStr: new Date().toLocaleString()
            };
            
            generatedFiles.unshift(file); // Add to beginning of array
            saveGeneratedFiles();
        }

        // Display generated files
        function displayGeneratedFiles() {
            const filesList = document.getElementById('files-list');
            
            if (generatedFiles.length === 0) {
                filesList.innerHTML = '<p style="color: #666; text-align: center;">No files generated yet.</p>';
                return;
            }

            filesList.innerHTML = generatedFiles.map(file => `
                <div class="generated-file-item">
                    <div class="file-info">
                        <div class="file-name">
                            ${file.type === 'resume' ? 'üìÑ' : '‚úâÔ∏è'} 
                            ${file.type === 'resume' ? 'Resume' : 'Cover Letter'} - ${file.jobTitle}
                        </div>
                        <div class="file-meta">Generated on ${file.dateStr}</div>
                    </div>
                    <div class="file-actions">
                        <button class="btn-secondary" onclick="viewFile(${file.id})">View</button>
                        <button class="btn-secondary" onclick="downloadFileAsDOCX(${file.id})">Download DOCX</button>
                        <button class="btn-danger" onclick="deleteFile(${file.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function viewFile(fileId) {
            const file = generatedFiles.find(f => f.id === fileId);
            if (!file) return;

            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = `
                <h3>${file.type === 'resume' ? 'Resume' : 'Cover Letter'} - ${file.jobTitle}</h3>
                <div class="document-output">${file.content}</div>
                <div class="button-group" style="margin-top: 24px;">
                    <button class="btn-secondary" onclick="copyToClipboard(\`${file.content.replace(/`/g, '\\`')}\`)">Copy Text</button>
                    <button class="btn-primary" onclick="downloadFileAsDOCX(${file.id})">Download as DOCX</button>
                </div>
            `;
            
            showSection('results-section');
        }

        function deleteFile(fileId) {
            if (confirm('Are you sure you want to delete this file?')) {
                generatedFiles = generatedFiles.filter(f => f.id !== fileId);
                saveGeneratedFiles();
                displayGeneratedFiles();
            }
        }

        async function downloadFileAsDOCX(fileId) {
            const file = generatedFiles.find(f => f.id === fileId);
            if (!file) return;

            try {
                if (typeof window.docx === 'undefined') {
                    throw new Error('DOCX library not loaded. Please refresh the page and try again.');
                }

                const { Document, Packer, Paragraph, TextRun, AlignmentType } = window.docx;

                const lines = file.content.split('\n');
                const children = lines.map(line => {
                    const trimmed = line.trim();
                    if (!trimmed) {
                        return new Paragraph({ children: [new TextRun('')] });
                    }

                    // Check if it's a header (all caps or starts with specific markers)
                    const isHeader = trimmed === trimmed.toUpperCase() && trimmed.length < 50;
                    
                    return new Paragraph({
                        children: [
                            new TextRun({
                                text: trimmed,
                                bold: isHeader,
                                size: isHeader ? 28 : 22
                            })
                        ],
                        spacing: { after: isHeader ? 150 : 100 }
                    });
                });

                const doc = new Document({
                    sections: [{
                        properties: {
                            page: {
                                margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 }
                            }
                        },
                        children: children
                    }]
                });

                const blob = await Packer.toBlob(doc);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${file.jobTitle.replace(/[^a-z0-9]/gi, '_')}_${file.type}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error creating DOCX:', error);
                alert('Error creating DOCX file. You can use the Copy Text button instead.');
            }
        }

        function showGeneratedFiles() {
            previousSection = document.querySelector('.section.active').id;
            displayGeneratedFiles();
            showSection('generated-files-section');
        }

        function returnToPreviousSection() {
            if (previousSection) {
                showSection(previousSection);
            } else {
                showSection('job-analysis-section');
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        function showManualEntry() {
            document.getElementById('manual-entry-form').classList.remove('hidden');
            document.getElementById('document-upload-form').classList.add('hidden');
        }

        function hideManualEntry() {
            document.getElementById('manual-entry-form').classList.add('hidden');
        }

        function showDocumentUpload() {
            document.getElementById('document-upload-form').classList.remove('hidden');
            document.getElementById('manual-entry-form').classList.add('hidden');
        }

        function hideDocumentUpload() {
            document.getElementById('document-upload-form').classList.add('hidden');
        }

        async function saveManualProfile() {
            profileData = {
                contact: {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    location: document.getElementById('location').value,
                    linkedin: document.getElementById('linkedin').value
                },
                experience: document.getElementById('experience').value,
                skills: document.getElementById('skills').value,
                education: document.getElementById('education').value,
                certifications: document.getElementById('certifications').value
            };

            // Save to storage
            try {
                await window.storage.set('job-assistant-profile', JSON.stringify(profileData));
            } catch (error) {
                console.error('Error saving profile:', error);
            }

            displayProfileForReview();
            showSection('review-section');
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            const statusDiv = document.getElementById('upload-status');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Processing documents...</p></div>';

            let extractedText = '';

            for (let file of files) {
                try {
                    let text = '';
                    if (file.type === 'application/pdf') {
                        text = await extractTextFromPDF(file);
                    } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                        text = await extractTextFromDOCX(file);
                    } else if (file.type === 'text/plain') {
                        text = await file.text();
                    }
                    extractedText += text + '\n\n';
                } catch (error) {
                    console.error('Error processing file:', error);
                }
            }

            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing with AI...</p></div>';

            await parseExtractedText(extractedText);
            displayProfileForReview();
            
            statusDiv.innerHTML = '<div class="alert alert-success">Documents processed successfully!</div>';
            setTimeout(() => {
                showSection('review-section');
            }, 1500);
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const pageText = content.items.map(item => item.str).join(' ');
                text += pageText + '\n';
            }
            
            return text;
        }

        async function extractTextFromDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        async function parseExtractedText(text) {
            // Call Claude API to parse the text
            const systemPrompt = `You are parsing a resume/CV document. Extract and categorize the following information:
- Contact information (name, email, phone, location, LinkedIn)
- Work experience
- Skills
- Education
- Certifications

Return the information in this exact JSON format:
{
  "contact": {
    "name": "",
    "email": "",
    "phone": "",
    "location": "",
    "linkedin": ""
  },
  "experience": "",
  "skills": "",
  "education": "",
  "certifications": ""
}`;

            try {
                const response = await callClaudeAPI(systemPrompt, text);
                profileData = JSON.parse(response);
                
                // Save to storage
                await window.storage.set('job-assistant-profile', JSON.stringify(profileData));
            } catch (error) {
                console.error('Error parsing with AI:', error);
                // Fallback: just use the raw text
                profileData = {
                    contact: { name: '', email: '', phone: '', location: '', linkedin: '' },
                    experience: text,
                    skills: '',
                    education: '',
                    certifications: ''
                };
            }
        }

        function displayProfileForReview() {
            const reviewDiv = document.getElementById('profile-review');
            reviewDiv.innerHTML = `
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="review-name" value="${profileData.contact.name || ''}">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="review-email" value="${profileData.contact.email || ''}">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="review-phone" value="${profileData.contact.phone || ''}">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="review-location" value="${profileData.contact.location || ''}">
                </div>
                <div class="form-group">
                    <label>LinkedIn</label>
                    <input type="url" id="review-linkedin" value="${profileData.contact.linkedin || ''}">
                </div>
                <div class="form-group">
                    <label>Work Experience</label>
                    <textarea id="review-experience">${profileData.experience || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Skills</label>
                    <textarea id="review-skills">${profileData.skills || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Education</label>
                    <textarea id="review-education">${profileData.education || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Certifications</label>
                    <textarea id="review-certifications">${profileData.certifications || ''}</textarea>
                </div>
            `;
        }

        function editProfile() {
            // Update profile data from review fields
            profileData = {
                contact: {
                    name: document.getElementById('review-name').value,
                    email: document.getElementById('review-email').value,
                    phone: document.getElementById('review-phone').value,
                    location: document.getElementById('review-location').value,
                    linkedin: document.getElementById('review-linkedin').value
                },
                experience: document.getElementById('review-experience').value,
                skills: document.getElementById('review-skills').value,
                education: document.getElementById('review-education').value,
                certifications: document.getElementById('review-certifications').value
            };
        }

        async function confirmProfile() {
            editProfile(); // Save any changes
            
            // Save to storage
            try {
                await window.storage.set('job-assistant-profile', JSON.stringify(profileData));
            } catch (error) {
                console.error('Error saving profile:', error);
            }
            
            showSection('job-analysis-section');
        }

        async function startOver() {
            if (confirm('This will delete your profile. Are you sure?')) {
                profileData = null;
                try {
                    await window.storage.delete('job-assistant-profile');
                } catch (error) {
                    console.error('Error deleting profile:', error);
                }
                showSection('setup-section');
                hideManualEntry();
                hideDocumentUpload();
            }
        }

        async function analyzeJob() {
            const jobDesc = document.getElementById('job-description').value.trim();
            
            if (!jobDesc) {
                alert('Please paste a job description');
                return;
            }

            // Check if it's a URL
            if (jobDesc.startsWith('http://') || jobDesc.startsWith('https://') || jobDesc.startsWith('www.')) {
                const resultDiv = document.getElementById('analysis-result');
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `
                    <div class="alert alert-info">
                        <strong>üîó URL Detected</strong><br>
                        I cannot fetch URLs directly from this tool. Please share this URL with me in the chat, and I'll fetch the full job description for you!<br><br>
                        Alternatively, you can copy and paste the job description text here instead.
                    </div>
                `;
                return;
            }

            currentJobDescription = jobDesc;
            
            const resultDiv = document.getElementById('analysis-result');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing job match...</p></div>';

            try {
                const systemPrompt = `You are a job matching expert. Analyze how well this candidate's profile matches the job description.

Candidate Profile:
${JSON.stringify(profileData, null, 2)}

Return your analysis in this JSON format:
{
  "matchScore": <number 0-100>,
  "jobTitle": "<extracted job title>",
  "strengths": ["strength1", "strength2", ...],
  "gaps": ["gap1", "gap2", ...],
  "recommendations": ["rec1", "rec2", ...]
}`;

                const response = await callClaudeAPI(systemPrompt, `Job Description:\n${jobDesc}`);
                currentAnalysis = JSON.parse(response);
                
                displayAnalysisResults();
            } catch (error) {
                console.error('Error analyzing job:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger">Error analyzing job. Please try again.</div>`;
            }
        }

        function displayAnalysisResults() {
            const score = currentAnalysis.matchScore;
            let matchClass = 'match-poor';
            let matchText = 'Poor Match';
            
            if (score >= 90) {
                matchClass = 'match-excellent';
                matchText = 'Excellent Match';
            } else if (score >= 80) {
                matchClass = 'match-good';
                matchText = 'Good Match';
            } else if (score >= 70) {
                matchClass = 'match-fair';
                matchText = 'Fair Match';
            }

            const resultDiv = document.getElementById('analysis-result');
            resultDiv.innerHTML = `
                <h3>Job Match Analysis</h3>
                <div class="match-badge ${matchClass}">${matchText}: ${score}%</div>
                
                <h4 style="margin-top: 24px;">‚úÖ Strengths</h4>
                <ul style="margin: 12px 0; padding-left: 24px;">
                    ${currentAnalysis.strengths.map(s => `<li>${s}</li>`).join('')}
                </ul>
                
                ${currentAnalysis.gaps.length > 0 ? `
                    <h4 style="margin-top: 24px;">‚ö†Ô∏è Gaps</h4>
                    <ul style="margin: 12px 0; padding-left: 24px;">
                        ${currentAnalysis.gaps.map(g => `<li>${g}</li>`).join('')}
                    </ul>
                ` : ''}
                
                <h4 style="margin-top: 24px;">üí° Recommendations</h4>
                <ul style="margin: 12px 0; padding-left: 24px;">
                    ${currentAnalysis.recommendations.map(r => `<li>${r}</li>`).join('')}
                </ul>
                
                <div class="button-group" style="margin-top: 32px;">
                    ${score >= 70 ? `
                        <button class="btn-primary" onclick="generateResume()">Generate Resume</button>
                        <button class="btn-secondary" onclick="generateCoverLetter()">Generate Cover Letter</button>
                    ` : `
                        <button class="btn-secondary" onclick="showSection('job-analysis-section')">Try Another Job</button>
                    `}
                </div>
            `;
        }

        async function generateResume() {
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating tailored resume...</p></div>';
            showSection('results-section');

            try {
                const systemPrompt = `Generate a professional resume tailored to this job. Format it cleanly with clear sections.

Candidate Profile:
${JSON.stringify(profileData, null, 2)}

Job Analysis:
${JSON.stringify(currentAnalysis, null, 2)}

IMPORTANT: Write naturally and professionally. Avoid AI clich√©s like "spearheaded", "game-changing", excessive em dashes, or overly enthusiastic language.`;

                const resume = await callClaudeAPI(systemPrompt, `Job Description:\n${currentJobDescription}`);
                
                // Save to generated files
                addGeneratedFile('resume', currentAnalysis.jobTitle, resume);
                
                resultsContent.innerHTML = `
                    <h3>Your Tailored Resume</h3>
                    <div class="document-output">${resume}</div>
                    <div class="button-group" style="margin-top: 24px;">
                        <button class="btn-secondary" onclick="copyToClipboard(\`${resume.replace(/`/g, '\\`')}\`)">Copy Text</button>
                        <button class="btn-primary" onclick="downloadResumeAsDOCX()">Download as DOCX</button>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating resume:', error);
                resultsContent.innerHTML = `<div class="alert alert-danger">Error generating resume. Please try again.</div>`;
            }
        }

        async function generateCoverLetter() {
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating cover letter...</p></div>';
            showSection('results-section');

            try {
                const systemPrompt = `Generate a compelling cover letter for this job. Be authentic and professional.

Candidate Profile:
${JSON.stringify(profileData, null, 2)}

Job Analysis:
${JSON.stringify(currentAnalysis, null, 2)}

IMPORTANT: Write in a natural, conversational tone. Avoid AI clich√©s, excessive enthusiasm, or generic corporate speak. Be specific and genuine.`;

                const coverLetter = await callClaudeAPI(systemPrompt, `Job Description:\n${currentJobDescription}`);
                
                // Save to generated files
                addGeneratedFile('coverLetter', currentAnalysis.jobTitle, coverLetter);
                
                resultsContent.innerHTML = `
                    <h3>Your Cover Letter</h3>
                    <div class="document-output">${coverLetter}</div>
                    <div class="button-group" style="margin-top: 24px;">
                        <button class="btn-secondary" onclick="copyToClipboard(\`${coverLetter.replace(/`/g, '\\`')}\`)">Copy Text</button>
                        <button class="btn-primary" onclick="downloadCoverLetterAsDOCX()">Download as DOCX</button>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating cover letter:', error);
                resultsContent.innerHTML = `<div class="alert alert-danger">Error generating cover letter. Please try again.</div>`;
            }
        }

        async function downloadResumeAsDOCX() {
            // Get the latest resume from the results section
            const documentOutput = document.querySelector('#results-section .document-output');
            if (!documentOutput) return;
            
            const resumeText = documentOutput.textContent;
            
            try {
                if (typeof window.docx === 'undefined') {
                    throw new Error('DOCX library not loaded. Please refresh the page and try again.');
                }

                const { Document, Packer, Paragraph, TextRun } = window.docx;

                const lines = resumeText.split('\n');
                const children = lines.map(line => {
                    const trimmed = line.trim();
                    if (!trimmed) {
                        return new Paragraph({ children: [new TextRun('')] });
                    }

                    const isHeader = trimmed === trimmed.toUpperCase() && trimmed.length < 50;
                    
                    return new Paragraph({
                        children: [
                            new TextRun({
                                text: trimmed,
                                bold: isHeader,
                                size: isHeader ? 28 : 22
                            })
                        ],
                        spacing: { after: isHeader ? 150 : 100 }
                    });
                });

                const doc = new Document({
                    sections: [{
                        properties: {
                            page: {
                                margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 }
                            }
                        },
                        children: children
                    }]
                });

                const blob = await Packer.toBlob(doc);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${profileData.contact.name.replace(/\s+/g, '_')}_Resume.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error creating DOCX:', error);
                alert('Error creating DOCX file. You can use the Copy Text button instead.');
            }
        }

        async function downloadCoverLetterAsDOCX() {
            const documentOutput = document.querySelector('#results-section .document-output');
            if (!documentOutput) return;
            
            const coverLetterText = documentOutput.textContent;
            
            try {
                if (typeof window.docx === 'undefined') {
                    throw new Error('DOCX library not loaded. Please refresh the page and try again.');
                }

                const { Document, Packer, Paragraph, TextRun } = window.docx;

                const paragraphs = coverLetterText.split('\n\n').filter(p => p.trim());
                const children = paragraphs.map(para => {
                    return new Paragraph({
                        children: [
                            new TextRun({
                                text: para.trim(),
                                size: 22
                            })
                        ],
                        spacing: { after: 200 }
                    });
                });

                const doc = new Document({
                    sections: [{
                        properties: {
                            page: {
                                margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 }
                            }
                        },
                        children: children
                    }]
                });

                const blob = await Packer.toBlob(doc);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${profileData.contact.name.replace(/\s+/g, '_')}_CoverLetter.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error creating DOCX:', error);
                alert('Error creating DOCX file. You can use the Copy Text button instead.');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            }).catch(err => {
                console.error('Error copying to clipboard:', err);
                alert('Failed to copy. Please select and copy manually.');
            });
        }

        async function callClaudeAPI(systemPrompt, userMessage) {
            const netlifyFunctionUrl = 'https://curious-rugelach-e5ffb8.netlify.app/.netlify/functions/claude-proxy';
            
            const response = await fetch(netlifyFunctionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    systemPrompt: systemPrompt,
                    userMessage: userMessage,
                    maxTokens: 4000
                })
            });

            if (!response.ok) {
                throw new Error(`API call failed: ${response.statusText}`);
            }

            const data = await response.json();
            return data.content[0].text;
        }
    </script>
</body>
</html>
