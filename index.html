<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartApply - Your AI Job Application Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* === 1. GLASSMORPHISM & DEPTH === */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 25%, #475569 50%, #334155 75%, #1e293b 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            min-height: 100vh;
            padding: 0;
            color: #1a1a1a;
            position: relative;
            overflow-x: hidden;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Multi-layer background depth */
        .bg-orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.4;
            pointer-events: none;
            z-index: 0;
        }

        .bg-orb-1 {
            width: 900px;
            height: 900px;
            background: radial-gradient(circle, rgba(71, 85, 105, 0.4) 0%, transparent 70%);
            top: -450px;
            right: -300px;
            animation: float1 25s ease-in-out infinite;
        }

        .bg-orb-2 {
            width: 700px;
            height: 700px;
            background: radial-gradient(circle, rgba(51, 65, 85, 0.35) 0%, transparent 70%);
            bottom: -250px;
            left: -200px;
            animation: float2 30s ease-in-out infinite;
        }

        .bg-orb-3 {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(100, 116, 139, 0.3) 0%, transparent 70%);
            top: 40%;
            right: 30%;
            animation: float3 35s ease-in-out infinite;
        }

        @keyframes float1 {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(60px, -60px) rotate(120deg); }
            66% { transform: translate(-40px, 40px) rotate(240deg); }
        }

        @keyframes float2 {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-50px, 50px) rotate(-120deg); }
            66% { transform: translate(40px, -40px) rotate(-240deg); }
        }

        @keyframes float3 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(30px, -30px) scale(1.15); }
        }

        /* Texture overlay */
        .texture-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(45deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(-45deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 30px 30px;
            pointer-events: none;
            z-index: 0;
        }

        /* === 10. PROFESSIONAL LAYOUTS === */
        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Sidebar navigation */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(40px) saturate(180%);
            border-right: 1px solid rgba(255, 255, 255, 0.18);
            padding: 32px 24px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            /* === 9. ADVANCED SHADOWS === */
            box-shadow: 
                4px 0 24px rgba(0, 0, 0, 0.06),
                2px 0 12px rgba(0, 0, 0, 0.04),
                1px 0 4px rgba(0, 0, 0, 0.02),
                inset -1px 0 0 rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 56px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            backdrop-filter: blur(20px);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            text-shadow: none;
            /* box-shadow removed per user request */
        }

        /* === 7. ADVANCED TYPOGRAPHY === */
        .logo-text {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 18px;
            font-weight: 800;
            color: white;
            letter-spacing: -0.5px;
            /* text-shadow removed per user request */
        }

        /* Navigation menu */
        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        /* === 6. MICRO-INTERACTIONS === */
        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.12);
            color: white;
            transform: translateX(4px);
        }

        .nav-link:hover::before {
            left: 100%;
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.18);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .nav-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* Main content area */
        .main-content {
            flex: 1;
            padding: 48px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* === 1. GLASSMORPHISM === */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px) saturate(180%);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            /* === 9. MULTI-LAYER SHADOWS === */
            box-shadow: 
                0 24px 60px rgba(0, 0, 0, 0.12),
                0 12px 30px rgba(0, 0, 0, 0.08),
                0 6px 12px rgba(0, 0, 0, 0.04),
                0 2px 4px rgba(0, 0, 0, 0.02),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            padding: 40px;
            margin-bottom: 32px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #14b8a6 0%, #06b6d4 50%, #14b8a6 100%);
            background-size: 200% 100%;
            opacity: 0;
            transition: opacity 0.4s;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .glass-card:hover {
            transform: translateY(-8px);
            box-shadow: 
                0 32px 80px rgba(20, 184, 166, 0.15),
                0 16px 40px rgba(0, 0, 0, 0.10),
                0 8px 16px rgba(0, 0, 0, 0.06),
                0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .glass-card:hover::before {
            opacity: 1;
        }

        /* === 7. ADVANCED TYPOGRAPHY === */
        .section-header {
            margin-bottom: 40px;
        }

        h1 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 56px;
            font-weight: 800;
            letter-spacing: -2.5px;
            line-height: 1.1;
            margin-bottom: 16px;
            /* Text gradient */
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 50%, #5eead4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% 200%;
            animation: gradientText 6s ease infinite;
        }

        @keyframes gradientText {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        h2 {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
            color: #ffffff;
            margin-bottom: 24px;
        }

        h3 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: #334155;
            margin-bottom: 16px;
        }

        .subtitle {
            font-size: 18px;
            font-weight: 500;
            color: #cbd5e1;
            line-height: 1.6;
            letter-spacing: -0.2px;
        }

        /* === 2. PREMIUM INPUTS === */
        .form-group {
            margin-bottom: 28px;
            position: relative;
        }

        .input-wrapper {
            position: relative;
        }

        /* Floating label */
        .floating-label {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 15px;
            font-weight: 600;
            color: #9ca3af;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            background: white;
            padding: 0 8px;
        }

        input:focus ~ .floating-label,
        input:not(:placeholder-shown) ~ .floating-label,
        textarea:focus ~ .floating-label,
        textarea:not(:placeholder-shown) ~ .floating-label {
            top: 0;
            font-size: 12px;
            font-weight: 700;
            color: #14b8a6;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        input, textarea, select {
            width: 100%;
            padding: 18px 20px 18px 48px;
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 500;
            color: #1a1a1a;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.04),
                inset 0 1px 2px rgba(0, 0, 0, 0.02);
        }

        input::placeholder,
        textarea::placeholder {
            color: transparent;
        }

        /* Input icons */
        .input-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: #9ca3af;
            transition: color 0.3s;
            pointer-events: none;
        }

        input:focus ~ .input-icon,
        textarea:focus ~ .input-icon {
            color: #14b8a6;
        }

        /* Premium focus state */
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: transparent;
            background: #ffffff;
            box-shadow: 
                0 0 0 4px rgba(20, 184, 166, 0.12),
                0 8px 24px rgba(20, 184, 166, 0.15),
                0 4px 12px rgba(0, 0, 0, 0.06),
                inset 0 2px 4px rgba(20, 184, 166, 0.08);
            transform: translateY(-2px);
        }

        textarea {
            min-height: 140px;
            resize: vertical;
            padding-top: 20px;
        }

        textarea ~ .floating-label {
            top: 24px;
        }

        textarea:focus ~ .floating-label,
        textarea:not(:placeholder-shown) ~ .floating-label {
            top: 0;
        }

        /* === 3. SOPHISTICATED BUTTONS === */
        .button-group {
            display: flex;
            gap: 16px;
            margin-top: 32px;
            flex-wrap: wrap;
        }

        button {
            padding: 18px 32px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: -0.2px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%);
            color: white;
            box-shadow: 
                0 8px 24px rgba(20, 184, 166, 0.35),
                0 4px 12px rgba(20, 184, 166, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.6s;
        }

        .btn-primary:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 
                0 16px 40px rgba(20, 184, 166, 0.45),
                0 8px 20px rgba(20, 184, 166, 0.30),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:active {
            transform: translateY(-2px) scale(0.98);
        }

        .btn-secondary {
            background: #ffffff;
            color: #334155;
            border: 2px solid #14b8a6;
            box-shadow: 
                0 4px 12px rgba(20, 184, 166, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.08) 0%, rgba(6, 182, 212, 0.08) 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(20, 184, 166, 0.25);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.35);
        }

        .btn-danger:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(239, 68, 68, 0.45);
        }

        /* Button loading state */
        .btn-loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* === 4. DATA VISUALIZATION === */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin: 32px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            padding: 32px 24px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #14b8a6, #06b6d4, #14b8a6);
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.4s;
            z-index: -1;
        }

        .stat-card:hover {
            border-color: transparent;
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 20px 50px rgba(20, 184, 166, 0.25),
                0 10px 25px rgba(0, 0, 0, 0.08);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        /* Circular progress ring */
        .stat-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            position: relative;
        }

        .stat-ring svg {
            transform: rotate(-90deg);
        }

        .stat-ring-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 8;
        }

        .stat-ring-progress {
            fill: none;
            stroke: url(#statGradient);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            font-weight: 900;
            color: #334155;
        }

        .stat-label {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 13px;
            color: #6b7280;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 12px;
        }

        /* Animated counter */
        .counter {
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 20px 0 12px;
            letter-spacing: -2px;
        }

        /* === 5. ILLUSTRATIONS / GRAPHICS === */
        .hero-illustration {
            text-align: center;
            padding: 60px 0;
            position: relative;
        }

        .hero-graphic {
            width: 200px;
            height: 200px;
            margin: 0 auto 32px;
            position: relative;
            animation: floatIllustration 6s ease-in-out infinite;
        }

        @keyframes floatIllustration {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .hero-graphic-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.25), rgba(6, 182, 212, 0.25));
            position: relative;
            box-shadow: 
                0 20px 60px rgba(20, 184, 166, 0.3),
                inset 0 -10px 30px rgba(20, 184, 166, 0.2);
        }

        .hero-graphic-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        /* Abstract decorative shapes */
        .decoration-shape {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.12), rgba(100, 116, 139, 0.12));
            animation: float 20s ease-in-out infinite;
        }

        .decoration-shape-1 {
            width: 100px;
            height: 100px;
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }

        .decoration-shape-2 {
            width: 150px;
            height: 150px;
            top: 60%;
            right: 10%;
            animation-delay: 2s;
        }

        .decoration-shape-3 {
            width: 80px;
            height: 80px;
            bottom: 20%;
            left: 15%;
            animation-delay: 4s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(20px, -20px) scale(1.1); }
            66% { transform: translate(-15px, 15px) scale(0.9); }
        }

        /* === 8. COLOR SOPHISTICATION === */
        /* Success/Warning/Error system */
        .alert {
            padding: 20px 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            border-left: 6px solid;
            font-weight: 600;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.08));
            color: #065f46;
            border-color: #10b981;
        }

        .alert-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(220, 38, 38, 0.08));
            color: #991b1b;
            border-color: #ef4444;
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(37, 99, 235, 0.08));
            color: #1e40af;
            border-color: #3b82f6;
        }

        .alert-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(217, 119, 6, 0.08));
            color: #92400e;
            border-color: #f59e0b;
        }

        /* Badge system */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
        }

        .badge-primary {
            background: linear-gradient(135deg, #14b8a6, #06b6d4);
            color: white;
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.35);
        }

        .badge-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.35);
        }

        /* Section visibility */
        .section {
            display: none;
            animation: fadeSlideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .section.active {
            display: block;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading states */
        .loading-skeleton {
            background: linear-gradient(90deg, #e5e7eb 0%, #f3f4f6 50%, #e5e7eb 100%);
            background-size: 200% 100%;
            animation: skeleton 1.5s ease-in-out infinite;
            border-radius: 12px;
            height: 20px;
            margin-bottom: 12px;
        }

        @keyframes skeleton {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(20, 184, 166, 0.2);
            border-top-color: #14b8a6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }

        /* Document output */
        .document-output {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 32px;
            margin-top: 24px;
            font-family: 'Inter', monospace;
            font-size: 14px;
            line-height: 1.8;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        /* Custom scrollbar */
        .document-output::-webkit-scrollbar {
            width: 12px;
        }

        .document-output::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 10px;
        }

        .document-output::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #14b8a6, #06b6d4);
            border-radius: 10px;
        }

        .document-output::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #0d9488, #0891b2);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar {
                width: 240px;
            }

            .main-content {
                padding: 32px;
            }
        }

        @media (max-width: 968px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 24px;
            }

            .main-content {
                padding: 24px 16px;
            }

            h1 {
                font-size: 40px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }

        /* File upload zone */
        .file-upload-zone {
            border: 3px dashed #14b8a6;
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
            cursor: pointer;
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }

        .file-upload-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .file-upload-zone:hover {
            border-color: #06b6d4;
            transform: scale(1.02);
            box-shadow: 0 12px 40px rgba(20, 184, 166, 0.2);
        }

        .file-upload-zone:hover::before {
            opacity: 1;
        }

        .file-upload-icon {
            font-size: 64px;
            margin-bottom: 16px;
            animation: floatIcon 3s ease-in-out infinite;
        }

        @keyframes floatIcon {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Match badge */
        .match-badge {
            display: inline-block;
            padding: 16px 32px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 32px;
            margin: 24px 0;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
            letter-spacing: -1px;
        }

        .match-excellent {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
        }

        .match-good {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
        }

        .match-fair {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
        }

        .match-poor {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
        }
    
    </style>
</head>
<body>

    <div class="bg-orb bg-orb-1"></div>
    <div class="bg-orb bg-orb-2"></div>
    <div class="bg-orb bg-orb-3"></div>
    <div class="texture-overlay"></div>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">

            <div class="logo">
                <div class="logo-icon">üéØ</div>
                <div class="logo-text">SmartApply</div>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link active" onclick="showSection('welcome-section')">
                            <span class="nav-icon">üè†</span>
                            <span>Home</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('setup-section')">
                            <span class="nav-icon">üë§</span>
                            <span>Profile</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('review-section')">
                            <span class="nav-icon">‚úì</span>
                            <span>Review</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('job-analysis-section')">
                            <span class="nav-icon">üéØ</span>
                            <span>Job Match</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('results-section')">
                            <span class="nav-icon">üìÑ</span>
                            <span>Documents</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('generated-files-section')">
                            <span class="nav-icon">üíæ</span>
                            <span>History</span>
                        </a>
                    </li>
                </ul>
            </nav>
        
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Welcome Section -->
            <div id="welcome-section" class="section active">
                <div class="section-header">
                    <h1>Find Your Perfect Role</h1>
                    <p class="subtitle">Your AI Job Application Assistant - Intelligent matching with instant resume and cover letter generation</p>
                </div>

                <div class="glass-card">
                    <div class="hero-illustration">
                        <div class="hero-graphic">
                            <div class="hero-graphic-circle">
                                <div class="hero-graphic-icon">üöÄ</div>
                            </div>
                        </div>
                        <div class="decoration-shape decoration-shape-1"></div>
                        <div class="decoration-shape decoration-shape-2"></div>
                        <div class="decoration-shape decoration-shape-3"></div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-ring">
                                <svg width="120" height="120">
                                    <defs>
                                        <linearGradient id="statGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#14b8a6"/>
                                            <stop offset="100%" style="stop-color:#06b6d4"/>
                                        </linearGradient>
                                    </defs>
                                    <circle class="stat-ring-bg" cx="60" cy="60" r="45"/>
                                    <circle class="stat-ring-progress" cx="60" cy="60" r="45" style="stroke-dashoffset: 70;"/>
                                </svg>
                                <div class="stat-ring-text">AI</div>
                            </div>
                            <div class="stat-label">Powered</div>
                        </div>

                        <div class="stat-card">
                            <div class="counter">60s</div>
                            <div class="stat-label">Average Time</div>
                        </div>

                        <div class="stat-card">
                            <div class="counter">ATS</div>
                            <div class="stat-label">Optimized</div>
                        </div>
                    </div>

                    <div class="button-group" style="justify-content: center;">
                        <button class="btn-primary" onclick="showSection('setup-section')">
                            <span>Get Started</span>
                            <span>‚Üí</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Setup Section -->
            <div id="setup-section" class="section">
                <h2>Profile Setup</h2>
                <p style="margin: 16px 0; color: #cbd5e1;">Choose how you'd like to set up your profile:</p>
                
                <!-- Document Upload Box -->
                <div class="file-upload-zone" onclick="document.getElementById('file-input-main').click()" style="margin-bottom: 24px;">
                    <p style="font-size: 48px; margin-bottom: 16px;">üìÑ</p>
                    <p style="font-weight: 600; margin-bottom: 8px; color: #1e293b;">Upload your resume/CV</p>
                    <p style="font-size: 14px; color: #94a3b8;">Supports PDF, DOCX, or TXT files</p>
                    <input type="file" id="file-input-main" accept=".pdf,.docx,.txt" multiple style="display: none;" onchange="handleMainFileUpload(event)">
                </div>
                <div id="main-upload-status" class="hidden"></div>
                
                <div style="text-align: center; margin: 24px 0;">
                    <button class="btn-secondary" onclick="showManualEntry()">Manual Entry</button>
                    <button class="btn-secondary" onclick="skipUploadToProceed()" style="margin-left: 16px;">Skip Upload</button>
                </div>

                <!-- Manual Entry Form (Full Page) -->
                <div id="manual-entry-form" class="hidden">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="name" required>
                    </div>

                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="email" required>
                    </div>

                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="phone">
                    </div>

                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="location" placeholder="City, State">
                    </div>

                    <div class="form-group">
                        <label>LinkedIn Profile</label>
                        <input type="url" id="linkedin" placeholder="https://linkedin.com/in/yourname">
                    </div>

                    <div class="form-group">
                        <label>Work Experience</label>
                        <textarea id="experience" placeholder="List your relevant work experience..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Skills</label>
                        <textarea id="skills" placeholder="List your key skills..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Education</label>
                        <textarea id="education" placeholder="Your educational background..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Certifications</label>
                        <textarea id="certifications" placeholder="Any relevant certifications..."></textarea>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" onclick="showSection('setup-section'); hideManualEntry()">Back</button>
                        <button class="btn-primary" onclick="saveManualProfile()">Save Profile</button>
                    </div>
                </div>


            </div>

            <!-- Review Section -->
            <div id="review-section" class="section">
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="showSection('setup-section')">‚Üê Back to Setup</button>
                </div>
                
                <h2>Review Your Profile</h2>
                <p style="margin: 16px 0; color: #cbd5e1;">Please review and edit if needed:</p>
                
                <div id="profile-review"></div>
                
                <div class="button-group">
                    <button class="btn-secondary" onclick="editProfile()">Edit Profile</button>
                    <button class="btn-danger" onclick="startOver()">Start Over</button>
                    <button class="btn-primary" onclick="confirmProfile()">Confirm & Continue</button>
                </div>
            </div>

            <!-- Job Analysis Section -->
            <div id="job-analysis-section" class="section">
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="showSection('review-section')">‚Üê Back to Profile</button>
                    <button class="btn-secondary" onclick="showGeneratedFiles()">üìÅ View Generated Files</button>
                </div>
                
                <h2>Analyze a Job Posting</h2>
                <p style="margin: 16px 0; color: #cbd5e1;">
                    Paste the job description below. 
                    <span style="font-size: 13px; color: #999;">
                        (Note: Due to browser security restrictions, this tool cannot fetch URLs directly. 
                        Copy and paste the text instead.)
                    </span>
                </p>
                
                <div class="form-group">
                    <label>Job Description</label>
                    <textarea id="job-description" placeholder="Paste the full job description here..." style="min-height: 200px;"></textarea>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="analyzeJob()">Analyze Job Match</button>
                </div>

                <div id="analysis-result" class="hidden"></div>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="section">
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="showSection('job-analysis-section')">‚Üê Back to Job Analysis</button>
                    <button class="btn-secondary" onclick="showGeneratedFiles()">üìÅ View Generated Files</button>
                </div>
                
                <div id="results-content"></div>
            </div>

            <!-- Generated Files Section -->
            <div id="generated-files-section" class="section">
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="returnToPreviousSection()">‚Üê Back</button>
                </div>
                
                <h2>Generated Files</h2>
                <p style="margin: 16px 0; color: #cbd5e1;">All your generated resumes and cover letters:</p>
                
                <div id="files-list" class="generated-files-list">
                    <p style="color: #cbd5e1; text-align: center;">No files generated yet.</p>
                </div>
            </div>

    <script>
        // Storage wrapper functions that work whether storage API is available or not
        async function safeStorageGet(key) {
            try {
                if (typeof window.storage !== 'undefined' && window.storage) {
                    return await window.storage.get(key);
                }
                // Fallback to localStorage
                const value = localStorage.getItem(key);
                return value ? { value: value } : null;
            } catch (error) {
                console.log('Storage get failed, using memory only:', error);
                return null;
            }
        }

        async function safeStorageSet(key, value) {
            try {
                if (typeof window.storage !== 'undefined' && window.storage) {
                    await window.storage.set(key, value);
                } else {
                    // Fallback to localStorage
                    localStorage.setItem(key, value);
                }
            } catch (error) {
                console.log('Storage set failed, continuing without persistence:', error);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            }).catch(err => {
                console.error('Error copying to clipboard:', err);
                alert('Failed to copy. Please select and copy manually.');
            });
        }

        function stripMarkdownCodeFences(text) {
            // Remove ```json or ``` code fences that Claude sometimes adds
            return text
                .replace(/^```json\s*/i, '')
                .replace(/^```\s*/, '')
                .replace(/\s*```$/, '')
                .trim();
        }

        async function callClaudeAPI(systemPrompt, userMessage) {
            const netlifyFunctionUrl = 'https://curious-rugelach-e5ffb8.netlify.app/.netlify/functions/claude-proxy';
            
            const response = await fetch(netlifyFunctionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    systemPrompt: systemPrompt,
                    userMessage: userMessage,
                    maxTokens: 4000,
                    temperature: 0
                })
            });

            if (!response.ok) {
                throw new Error(`API call failed: ${response.statusText}`);
            }

            const data = await response.json();
            const rawText = data.content[0].text;
            return stripMarkdownCodeFences(rawText);
        }





        async function safeStorageDelete(key) {
            try {
                if (typeof window.storage !== 'undefined' && window.storage) {
                    await window.storage.delete(key);
                } else {
                    localStorage.removeItem(key);
                }
            } catch (error) {
                console.log('Storage delete failed:', error);
            }
        }

        // Initialize storage
        let profileData = null;
        let currentJobDescription = null;
        let currentAnalysis = null;
        let currentResumeText = null;
        let currentCoverLetterText = null;
        let previousSection = null;
        let generatedFiles = [];

        // Load saved data
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // Load profile
                const savedProfile = await safeStorageGet('job-assistant-profile');
                if (savedProfile) {
                    profileData = JSON.parse(savedProfile.value);
                    showSection('job-analysis-section');
                }

                // Load generated files
                const savedFiles = await safeStorageGet('job-assistant-files');
                if (savedFiles) {
                    generatedFiles = JSON.parse(savedFiles.value);
                }
            } catch (error) {
                console.log('No saved data found');
            }
        });

        // Save generated files to storage
        async function saveGeneratedFiles() {
            try {
                await safeStorageSet('job-assistant-files', JSON.stringify(generatedFiles));
            } catch (error) {
                console.error('Error saving files:', error);
            }
        }

        // Add file to generated files list
        function addGeneratedFile(type, jobTitle, content) {
            const file = {
                id: Date.now(),
                type: type, // 'resume' or 'coverLetter'
                jobTitle: jobTitle,
                content: content,
                timestamp: new Date().toISOString(),
                dateStr: new Date().toLocaleString()
            };
            
            generatedFiles.unshift(file); // Add to beginning of array
            saveGeneratedFiles();
        }

        // Display generated files
        function displayGeneratedFiles() {
            const filesList = document.getElementById('files-list');
            
            if (generatedFiles.length === 0) {
                filesList.innerHTML = '<p style="color: #cbd5e1; text-align: center;">No files generated yet.</p>';
                return;
            }

            filesList.innerHTML = generatedFiles.map(file => `
                <div class="generated-file-item">
                    <div class="file-info">
                        <div class="file-name">
                            ${file.type === 'resume' ? 'üìÑ' : '‚úâÔ∏è'} 
                            ${file.type === 'resume' ? 'Resume' : 'Cover Letter'} - ${file.jobTitle}
                        </div>
                        <div class="file-meta">Generated on ${file.dateStr}</div>
                    </div>
                    <div class="file-actions">
                        <button class="btn-secondary" onclick="viewFile(${file.id})">View</button>
                        <button class="btn-secondary" onclick="downloadFileAsDOCX(${file.id})">Download DOCX</button>
                        <button class="btn-danger" onclick="deleteFile(${file.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function viewFile(fileId) {
            const file = generatedFiles.find(f => f.id === fileId);
            if (!file) return;

            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = `
                <h3>${file.type === 'resume' ? 'Resume' : 'Cover Letter'} - ${file.jobTitle}</h3>
                <div class="document-output">${file.content}</div>
                <div class="button-group" style="margin-top: 24px;">
                    <button class="btn-secondary" onclick="copyToClipboard(\`${file.content.replace(/[`]/g, '\\`')}\`)">Copy Text</button>
                    <button class="btn-primary" onclick="downloadFileAsDOCX(${file.id})">Download as DOCX</button>
                </div>
            `;
            
            showSection('results-section');
        }

        function deleteFile(fileId) {
            if (confirm('Are you sure you want to delete this file?')) {
                generatedFiles = generatedFiles.filter(f => f.id !== fileId);
                saveGeneratedFiles();
                displayGeneratedFiles();
            }
        }

        async function downloadFileAsDOCX(fileId) {
            const file = generatedFiles.find(f => f.id === fileId);
            if (!file) return;

            try {
                if (typeof JSZip === 'undefined') {
                    throw new Error('Required library not loaded. Please refresh the page.');
                }

                const zip = new JSZip();
                
                zip.file('[Content_Types].xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`);
                
                zip.folder('_rels').file('.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`);
                
                const wordFolder = zip.folder('word');
                wordFolder.folder('_rels').file('document.xml.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
</Relationships>`);
                
                let xmlParagraphs;
                if (file.type === 'coverLetter') {
                    const textParagraphs = file.content.split('\n\n').filter(p => p.trim() && !/^[-*_]{3,}$/.test(p.trim()));
                    xmlParagraphs = textParagraphs.map(para => {
                        const trimmed = para.trim();
                        
                        const parts = [];
                        const boldRegex = /\*\*(.+?)\*\*/g;
                        let lastIndex = 0;
                        let match;
                        
                        while ((match = boldRegex.exec(trimmed)) !== null) {
                            if (match.index > lastIndex) {
                                const beforeText = trimmed.substring(lastIndex, match.index);
                                if (beforeText) parts.push({ text: beforeText, bold: false });
                            }
                            parts.push({ text: match[1], bold: true });
                            lastIndex = match.index + match[0].length;
                        }
                        
                        if (lastIndex < trimmed.length) {
                            const remainingText = trimmed.substring(lastIndex);
                            if (remainingText) parts.push({ text: remainingText, bold: false });
                        }
                        
                        if (parts.length === 0) {
                            parts.push({ text: trimmed, bold: false });
                        }
                        
                        const runs = parts.map(part => {
                            const escaped = part.text
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/"/g, '&quot;')
                                .replace(/'/g, '&apos;');
                            
                            return `<w:r><w:rPr><w:sz w:val="22"/>${part.bold ? '<w:b/>' : ''}</w:rPr><w:t xml:space="preserve">${escaped}</w:t></w:r>`;
                        }).join('');
                        
                        return `<w:p><w:pPr><w:spacing w:after="240"/></w:pPr>${runs}</w:p>`;
                    }).join('');
                } else {
                    const HEADER_SPACING_BEFORE = 120;
                    const JOB_SECTION_SPACING_AFTER = 80;
                    
                    const lines = file.content.split('\n').filter(l => {
                        const t = l.trim();
                        return t && !/^[-*_]{3,}$/.test(t);
                    });
                    
                    xmlParagraphs = lines.map((line, index) => {
                        let trimmed = line.trim();
                        
                        const headerMatch = trimmed.match(/^(#{1,6})\s+(.+)$/);
                        let headerLevel = 0;
                        if (headerMatch) {
                            headerLevel = headerMatch[1].length;
                            trimmed = headerMatch[2];
                        }
                        
                        const cleanLine = trimmed.replace(/\*\*/g, '');
                        const isAllCaps = cleanLine === cleanLine.toUpperCase() && cleanLine.length > 2;
                        const isHeader = headerLevel > 0 || isAllCaps;
                        
                        const isBullet = /^[-‚Ä¢]\s/.test(trimmed);
                        
                        let isLastBulletInSection = false;
                        if (isBullet && index < lines.length - 1) {
                            const nextLine = lines[index + 1].trim();
                            const nextIsBullet = /^[-‚Ä¢]\s/.test(nextLine);
                            if (!nextIsBullet) {
                                const hasBold = /\*\*/.test(nextLine);
                                if (hasBold) {
                                    isLastBulletInSection = true;
                                }
                            }
                        }
                        
                        const parts = [];
                        const boldRegex = /\*\*(.+?)\*\*/g;
                        let lastIndex = 0;
                        let match;
                        
                        while ((match = boldRegex.exec(trimmed)) !== null) {
                            if (match.index > lastIndex) {
                                const beforeText = trimmed.substring(lastIndex, match.index);
                                if (beforeText) parts.push({ text: beforeText, bold: isHeader });
                            }
                            parts.push({ text: match[1], bold: true });
                            lastIndex = match.index + match[0].length;
                        }
                        
                        if (lastIndex < trimmed.length) {
                            const remainingText = trimmed.substring(lastIndex);
                            if (remainingText) parts.push({ text: remainingText, bold: isHeader });
                        }
                        
                        if (parts.length === 0) {
                            parts.push({ text: trimmed, bold: isHeader });
                        }
                        
                        const runs = parts.map(part => {
                            const escaped = part.text
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/"/g, '&quot;')
                                .replace(/'/g, '&apos;');
                            
                            const fontSize = isHeader ? 28 : 22;
                            const isBold = part.bold;
                            
                            return `<w:r><w:rPr><w:sz w:val="${fontSize}"/>${isBold ? '<w:b/>' : ''}</w:rPr><w:t xml:space="preserve">${escaped}</w:t></w:r>`;
                        }).join('');
                        
                        let spacingAfter = 0;
                        if (isLastBulletInSection) {
                            spacingAfter = JOB_SECTION_SPACING_AFTER;
                        }
                        const spacingBefore = isHeader ? HEADER_SPACING_BEFORE : 0;
                        
                        return `<w:p><w:pPr><w:spacing w:after="${spacingAfter}" w:before="${spacingBefore}"/></w:pPr>${runs}</w:p>`;
                    }).join('');
                }
                
                wordFolder.file('document.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:body>
    ${xmlParagraphs}
  </w:body>
</w:document>`);
                
                const blob = await zip.generateAsync({type: 'blob'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${file.jobTitle.replace(/[^a-z0-9]/gi, '_')}_${file.type}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error creating DOCX:', error);
                alert('Error creating DOCX file. You can use the Copy Text button instead.');
            }
        }

        function showGeneratedFiles() {
            previousSection = document.querySelector('.section.active').id;
            displayGeneratedFiles();
            showSection('generated-files-section');
        }

        function returnToPreviousSection() {
            if (previousSection) {
                showSection(previousSection);
            } else {
                showSection('job-analysis-section');
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        // Handle main file upload from setup page
        async function handleMainFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const statusDiv = document.getElementById('main-upload-status');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<p style="color: #14b8a6; font-weight: 600;">Processing documents...</p>';
            
            try {
                for (const file of files) {
                    await processUploadedFile(file);
                }
                
                statusDiv.innerHTML = '<p style="color: #10b981; font-weight: 600;">‚úì Documents processed successfully!</p>';
                
                // Auto-navigate to review after successful upload
                setTimeout(() => {
                    displayProfileForReview();
                    showSection('review-section');
                }, 1000);
                
            } catch (error) {
                console.error('Upload error:', error);
                statusDiv.innerHTML = '<p style="color: #ef4444; font-weight: 600;">Error processing documents. Please try again.</p>';
            }
        }

        // Skip upload and go to manual entry or proceed with blank
        function skipUploadToProceed() {
            // Check if profile has any data
            const hasData = profileData.contact.name || 
                           profileData.contact.email || 
                           profileData.experience ||
                           profileData.skills;
            
            if (!hasData) {
                alert('Please upload a document or manually enter your profile information first.');
                return;
            }
            
            // Has data, proceed to review
            displayProfileForReview();
            showSection('review-section');
        }

        // Show manual entry form
        function showManualEntry() {
            // Hide setup page, show manual entry form
            document.getElementById('manual-entry-form').classList.remove('hidden');
            document.getElementById('setup-section').style.display = 'none';
        }


        // Show location opt-in before document generation
        function showLocationOptIn() {
            const locationDiv = document.getElementById('location-optin');
            const displayLocation = document.getElementById('display-location');
            
            if (profileData.contact.location) {
                displayLocation.textContent = profileData.contact.location;
                locationDiv.classList.remove('hidden');
            } else {
                locationDiv.classList.add('hidden');
            }
        }

        // Get location setting for document generation
        function shouldIncludeLocation() {
            const checkbox = document.getElementById('include-location');
            return checkbox && checkbox.checked && profileData.contact.location;
        }

        function hideManualEntry() {
            document.getElementById('manual-entry-form').classList.add('hidden');
            document.getElementById('setup-section').style.display = 'block';
        }


        async function saveManualProfile() {
            profileData = {
                contact: {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    location: document.getElementById('location').value,
                    linkedin: document.getElementById('linkedin').value
                },
                experience: document.getElementById('experience').value,
                skills: document.getElementById('skills').value,
                education: document.getElementById('education').value,
                certifications: document.getElementById('certifications').value
            };

            // Save to storage
            try {
                await safeStorageSet('job-assistant-profile', JSON.stringify(profileData));
            } catch (error) {
                console.error('Error saving profile:', error);
            }

            displayProfileForReview();
            showSection('review-section');
        }


        async function processUploadedFile(file) {
            let extractedText = '';
            
            if (file.type === 'application/pdf') {
                extractedText = await extractTextFromPDF(file);
            } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                extractedText = await extractTextFromDOCX(file);
            } else if (file.type === 'text/plain') {
                extractedText = await file.text();
            } else {
                throw new Error('Unsupported file type. Please upload PDF, DOCX, or TXT files.');
            }
            
            // Parse the extracted text
            await parseExtractedText(extractedText);
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            const statusDiv = document.getElementById('upload-status');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Processing documents...</p></div>';

            let extractedText = '';

            for (let file of files) {
                try {
                    let text = '';
                    if (file.type === 'application/pdf') {
                        text = await extractTextFromPDF(file);
                    } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                        text = await extractTextFromDOCX(file);
                    } else if (file.type === 'text/plain') {
                        text = await file.text();
                    }
                    extractedText += text + '\n\n';
                } catch (error) {
                    console.error('Error processing file:', error);
                }
            }

            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing with AI...</p></div>';

            await parseExtractedText(extractedText);
            displayProfileForReview();
            
            statusDiv.innerHTML = '<div class="alert alert-success">Documents processed successfully!</div>';
            setTimeout(() => {
                showSection('review-section');
            }, 1500);
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const pageText = content.items.map(item => item.str).join(' ');
                text += pageText + '\n';
            }
            
            return text;
        }

        async function extractTextFromDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        async function parseExtractedText(text) {
            // Try AI parsing first if backend is available
            let aiParsed = false;
            
            try {
                const systemPrompt = `You are parsing a resume/CV document. Extract and categorize the following information:
- Contact information (name, email, phone, location, LinkedIn)
- Work experience
- Skills
- Education
- Certifications

Return ONLY valid JSON with no additional text, in this exact format:
{
  "contact": {
    "name": "",
    "email": "",
    "phone": "",
    "location": "",
    "linkedin": ""
  },
  "experience": "",
  "skills": "",
  "education": "",
  "certifications": ""
}`;

                const response = await callClaudeAPI(systemPrompt, text);
                profileData = JSON.parse(response);
                aiParsed = true;
                
                // Save to storage
                await safeStorageSet('job-assistant-profile', JSON.stringify(profileData));
            } catch (error) {
                console.error('AI parsing failed, using pattern-based parsing:', error);
                // Use smart pattern-based parsing instead
                profileData = parseResumeWithPatterns(text);
                
                // Save to storage
                try {
                    await safeStorageSet('job-assistant-profile', JSON.stringify(profileData));
                } catch (e) {
                    console.error('Storage error:', e);
                }
            }
        }

        function parseResumeWithPatterns(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            
            const result = {
                contact: { name: '', email: '', phone: '', location: '', linkedin: '' },
                experience: '',
                skills: '',
                education: '',
                certifications: ''
            };
            
            // Extract contact info
            const emailMatch = text.match(/[\w\.-]+@[\w\.-]+\.\w+/);
            if (emailMatch) result.contact.email = emailMatch[0];
            
            const phoneMatch = text.match(/(\+?\d{1}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/);
            if (phoneMatch) result.contact.phone = phoneMatch[0];
            
            const linkedinMatch = text.match(/(?:linkedin\.com\/in\/|linkedin\.com\/pub\/)[\w-]+/i);
            if (linkedinMatch) result.contact.linkedin = 'https://' + linkedinMatch[0];
            
            // Name is typically in first few lines before contact info
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                const line = lines[i];
                if (!line.match(/@|linkedin|http|[0-9]{3}/i) && line.length > 5 && line.length < 50) {
                    // Likely a name
                    const words = line.split(/\s+/);
                    if (words.length >= 2 && words.length <= 4) {
                        result.contact.name = line;
                        break;
                    }
                }
            }
            
            // Find section markers
            const sections = {
                experience: [],
                skills: [],
                education: [],
                certifications: []
            };
            
            let currentSection = null;
            const experienceKeywords = /experience|employment|work history|professional background/i;
            const skillsKeywords = /skills|competencies|technical skills|core competencies/i;
            const educationKeywords = /education|academic|degrees/i;
            const certificationKeywords = /certifications?|licenses|credentials/i;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const upperLine = line.toUpperCase();
                
                // Check if this line is a section header
                if (experienceKeywords.test(line)) {
                    currentSection = 'experience';
                    continue;
                } else if (skillsKeywords.test(line)) {
                    currentSection = 'skills';
                    continue;
                } else if (educationKeywords.test(line)) {
                    currentSection = 'education';
                    continue;
                } else if (certificationKeywords.test(line)) {
                    currentSection = 'certifications';
                    continue;
                }
                
                // Add content to current section
                if (currentSection && !line.match(/@|linkedin\.com|^\d{3}/i)) {
                    sections[currentSection].push(line);
                }
            }
            
            // If no sections were found, try to infer from content
            if (!sections.experience.length && !sections.skills.length && 
                !sections.education.length && !sections.certifications.length) {
                
                // Put most content in experience, try to extract education/skills
                let allText = lines.join('\n');
                
                // Look for degree keywords
                const degreeMatch = allText.match(/(Bachelor|Master|PhD|Associate|B\.S\.|M\.S\.|MBA).*?(\d{4}|\d{2})/i);
                if (degreeMatch) {
                    result.education = degreeMatch[0];
                    allText = allText.replace(degreeMatch[0], '');
                }
                
                // Everything else goes to experience
                result.experience = allText.trim();
            } else {
                result.experience = sections.experience.join('\n');
                result.skills = sections.skills.join('\n');
                result.education = sections.education.join('\n');
                result.certifications = sections.certifications.join('\n');
            }
            
            return result;
        }

        function displayProfileForReview() {
            const reviewDiv = document.getElementById('profile-review');
            reviewDiv.innerHTML = `
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="review-name" value="${profileData.contact.name || ''}">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="review-email" value="${profileData.contact.email || ''}">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="review-phone" value="${profileData.contact.phone || ''}">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="review-location" value="${profileData.contact.location || ''}">
                </div>
                <div class="form-group">
                    <label>LinkedIn</label>
                    <input type="url" id="review-linkedin" value="${profileData.contact.linkedin || ''}">
                </div>
                <div class="form-group">
                    <label>Work Experience</label>
                    <textarea id="review-experience">${profileData.experience || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Skills</label>
                    <textarea id="review-skills">${profileData.skills || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Education</label>
                    <textarea id="review-education">${profileData.education || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Certifications</label>
                    <textarea id="review-certifications">${profileData.certifications || ''}</textarea>
                </div>
            `;
        }

        function editProfile() {
            // Update profile data from review fields
            profileData = {
                contact: {
                    name: document.getElementById('review-name').value,
                    email: document.getElementById('review-email').value,
                    phone: document.getElementById('review-phone').value,
                    location: document.getElementById('review-location').value,
                    linkedin: document.getElementById('review-linkedin').value
                },
                experience: document.getElementById('review-experience').value,
                skills: document.getElementById('review-skills').value,
                education: document.getElementById('review-education').value,
                certifications: document.getElementById('review-certifications').value
            };
            
            // Navigate back to setup section to edit
            showSection('setup-section');
        }

        async function confirmProfile() {
            editProfile(); // Save any changes
            
            // Save to storage
            try {
                await safeStorageSet('job-assistant-profile', JSON.stringify(profileData));
            } catch (error) {
                console.error('Error saving profile:', error);
            }
            
            showSection('job-analysis-section');
        }

        async function startOver() {
            if (confirm('This will delete your profile. Are you sure?')) {
                profileData = null;
                try {
                    await safeStorageDelete('job-assistant-profile');
                } catch (error) {
                    console.error('Error deleting profile:', error);
                }
                showSection('setup-section');
                hideManualEntry();
                hideDocumentUpload();
            }
        }

        async function analyzeJob() {
            const jobDesc = document.getElementById('job-description').value.trim();
            
            if (!jobDesc) {
                alert('Please paste a job description');
                return;
            }

            // Check if it's a URL
            if (jobDesc.startsWith('http://') || jobDesc.startsWith('https://') || jobDesc.startsWith('www.')) {
                const resultDiv = document.getElementById('analysis-result');
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `
                    <div class="alert alert-info">
                        <strong>üîó URL Detected</strong><br>
                        Due to browser security and employer website restrictions, this tool cannot fetch job descriptions from URLs directly.<br><br>
                        <strong>Please copy the job description text and paste it here instead.</strong>
                    </div>
                `;
                return;
            }

            currentJobDescription = jobDesc;
            
            const resultDiv = document.getElementById('analysis-result');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing job match...</p></div>';

            try {
                const systemPrompt = `You are an experienced recruiter analyzing job match quality using a calibrated scoring system.

SCORING FRAMEWORK (Total = 100 points):
- Required Qualifications = 80 points (divide evenly among all required quals)
- Preferred/Bonus Qualifications = 20 points (divide evenly among all preferred quals)
- Maximum possible score = 100%

PARTIAL CREDIT RULES:
- Exact match = 100% of points for that qualification
- Close match (e.g., 9 years when 10+ required, related certification) = 90-95% of points
- Transferable skill (e.g., fintech ops when data center ops required) = 60-80% of points based on relevance
- Related but not direct (e.g., AI infrastructure when data center infrastructure required) = 60-70% of points
- Missing entirely = 0% of points

SCORE INTERPRETATION:
- 90-100%: Excellent Match - Meets all/nearly all required + strong on preferred
- 80-89%: Strong Match - Meets all required, some preferred
- 70-79%: Good Match - Meets most required, competitive candidate
- 60-69%: Fair Match - Meets minimum required, notable gaps
- Below 60%: Poor Match - Missing critical requirements

IMPORTANT GUIDELINES:
1. First, identify which qualifications are REQUIRED vs PREFERRED/BONUS
2. Calculate required score (out of 80 points) by evaluating each required qualification
3. Calculate preferred score (out of 20 points) by evaluating each preferred qualification
4. Sum the two scores for final match percentage
5. Years of experience: ¬±1-2 years from requirement should get 90-95% credit
6. Industry transfers: Strong program/project management skills transfer across industries (fintech ‚Üí data center, healthcare ‚Üí tech, etc.)
7. Focus on ability to DO THE JOB, not perfect credential matching
8. Certifications listed as "preferred" should not significantly impact score if missing

Candidate Profile:
${JSON.stringify(profileData, null, 2)}

Return your analysis in this JSON format:
{
  "matchScore": <number 0-100, calculated using the framework above>,
  "jobTitle": "<extracted job title>",
  "requiredQuals": {
    "total": <number of required qualifications>,
    "pointsEarned": <points earned out of 80>,
    "details": ["brief explanation of scoring for each required qual"]
  },
  "preferredQuals": {
    "total": <number of preferred qualifications>,
    "pointsEarned": <points earned out of 20>,
    "details": ["brief explanation of scoring for each preferred qual"]
  },
  "strengths": ["strength1", "strength2", ...],
  "gaps": ["gap1", "gap2", ...],
  "recommendations": ["rec1", "rec2", ...]
}`;

                const response = await callClaudeAPI(systemPrompt, `Job Description:\n${jobDesc}`);
                currentAnalysis = JSON.parse(response);
                
                displayAnalysisResults();
            } catch (error) {
                console.error('Error analyzing job:', error);
                resultDiv.innerHTML = `<div class="alert alert-danger">Error analyzing job. Please try again.</div>`;
            }
        }

        function displayAnalysisResults() {
            const score = currentAnalysis.matchScore;
            let matchClass = 'match-poor';
            let matchText = 'Poor Match';
            
            if (score >= 90) {
                matchClass = 'match-excellent';
                matchText = 'Excellent Match';
            } else if (score >= 80) {
                matchClass = 'match-good';
                matchText = 'Strong Match';
            } else if (score >= 70) {
                matchClass = 'match-fair';
                matchText = 'Good Match';
            } else if (score >= 60) {
                matchClass = 'match-fair';
                matchText = 'Fair Match';
            }

            const resultDiv = document.getElementById('analysis-result');
            
            // Build score breakdown HTML
            let scoreBreakdown = '';
            if (currentAnalysis.requiredQuals && currentAnalysis.preferredQuals) {
                const reqPercentage = ((currentAnalysis.requiredQuals.pointsEarned / 80) * 100).toFixed(0);
                const prefPercentage = currentAnalysis.preferredQuals.total > 0 
                    ? ((currentAnalysis.preferredQuals.pointsEarned / 20) * 100).toFixed(0) 
                    : 0;
                
                scoreBreakdown = `
                    <div style="background: #f9fafb; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <h4 style="margin-bottom: 16px;">üìä Score Breakdown</h4>
                        <div style="margin-bottom: 12px;">
                            <strong>Required Qualifications:</strong> ${currentAnalysis.requiredQuals.pointsEarned.toFixed(1)}/80 points (${reqPercentage}%)
                            <div style="font-size: 13px; color: #cbd5e1; margin-top: 4px;">
                                ${currentAnalysis.requiredQuals.details.map(d => `‚Ä¢ ${d}`).join('<br>')}
                            </div>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong>Preferred Qualifications:</strong> ${currentAnalysis.preferredQuals.pointsEarned.toFixed(1)}/20 points (${prefPercentage}%)
                            <div style="font-size: 13px; color: #cbd5e1; margin-top: 4px;">
                                ${currentAnalysis.preferredQuals.details.map(d => `‚Ä¢ ${d}`).join('<br>')}
                            </div>
                        </div>
                        <div style="border-top: 2px solid #667eea; padding-top: 12px; margin-top: 12px;">
                            <strong>Total Score:</strong> ${score}%
                        </div>
                    </div>
                `;
            }

            resultDiv.innerHTML = `
                <h3>Job Match Analysis</h3>
                <div class="match-badge ${matchClass}">${matchText}: ${score}%</div>
                
                ${scoreBreakdown}
                
                <h4 style="margin-top: 24px;">‚úÖ Strengths</h4>
                <ul style="margin: 12px 0; padding-left: 24px;">
                    ${currentAnalysis.strengths.map(s => `<li>${s}</li>`).join('')}
                </ul>
                
                ${currentAnalysis.gaps && currentAnalysis.gaps.length > 0 ? `
                    <h4 style="margin-top: 24px;">‚ö†Ô∏è Gaps</h4>
                    <ul style="margin: 12px 0; padding-left: 24px;">
                        ${currentAnalysis.gaps.map(g => `<li>${g}</li>`).join('')}
                    </ul>
                    <div style="margin-top: 20px; padding: 20px; background: white; border: 2px solid #f59e0b; border-radius: 8px;">
                        <h4 style="color: #92400e; margin-bottom: 10px;">üìù How have you addressed these gaps? (Optional)</h4>
                        <p style="color: #6b7280; font-size: 14px; margin-bottom: 10px; font-style: italic;">
                            Add context about skills, projects, or experience that address the gaps above. This helps create a more accurate resume.
                        </p>
                        <textarea id="gap-context" placeholder="Example: Completed IBM Generative AI certification (Dec 2025), built AI-powered Rovo agents reducing time by 99%, work daily with SQL and data visualization..." style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #d97706; border-radius: 6px; font-family: inherit; font-size: 14px;"></textarea>
                        <p style="color: #6b7280; font-size: 13px; margin-top: 8px; font-style: italic;">
                            This information will be incorporated naturally into your resume and cover letter.
                        </p>
                    </div>
                ` : ''}
                
                <h4 style="margin-top: 24px;">üí° Recommendations</h4>
                <ul style="margin: 12px 0; padding-left: 24px;">
                    ${currentAnalysis.recommendations.map(r => `<li>${r}</li>`).join('')}
                </ul>
                
                <div class="button-group" style="margin-top: 32px;">
                    ${currentAnalysis.gaps && currentAnalysis.gaps.length > 0 ? `
                        <button class="btn-secondary" onclick="editProfileToAddressGaps()">Edit Profile to Address Gaps</button>
                    ` : ''}
                    ${score >= 70 ? `
                        <button class="btn-primary" onclick="generateResume()">Generate Resume</button>
                        <button class="btn-secondary" onclick="generateCoverLetter()">Generate Cover Letter</button>
                    ` : `
                        <button class="btn-secondary" onclick="editProfileToAddressGaps()">Edit Profile</button>
                        <button class="btn-secondary" onclick="showSection('job-analysis-section')">Try Another Job</button>
                    `}
                </div>
            `;
        }

        function editProfileToAddressGaps() {
            // Show the review section pre-filled with current data so user can edit
            displayProfileForReview();
            showSection('review-section');
            
            // Add a helpful message at the top
            const reviewSection = document.getElementById('review-section');
            const existingAlert = reviewSection.querySelector('.edit-gaps-alert');
            if (!existingAlert) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-info edit-gaps-alert';
                alert.innerHTML = `
                    <strong>üí° Edit Your Profile</strong><br>
                    Update your profile to address the gaps identified in the job analysis. 
                    Add missing skills, experience, or qualifications that you have but weren't in your original profile.
                    <br><br>
                    <button class="btn-secondary" onclick="returnToAnalysis()" style="margin-top: 12px;">Return to Analysis</button>
                `;
                reviewSection.insertBefore(alert, reviewSection.querySelector('h2').nextSibling);
            }
        }

        function returnToAnalysis() {
            // Remove the alert
            const alert = document.querySelector('.edit-gaps-alert');
            if (alert) alert.remove();
            
            // Re-run the analysis with updated profile
            if (currentJobDescription) {
                showSection('job-analysis-section');
                // Automatically re-analyze with updated profile
                setTimeout(() => {
                    analyzeJob();
                }, 500);
            } else {
                showSection('job-analysis-section');
            }
        }


        async function reAnalyzeWithResume(resumeText) {
            try {
                const systemPrompt = `You are an experienced recruiter analyzing job match quality using a calibrated scoring system.

SCORING FRAMEWORK (Total = 100 points):
- Required Qualifications = 80 points (divide evenly among all required quals)
- Preferred/Bonus Qualifications = 20 points (divide evenly among all preferred quals)
- Maximum possible score = 100%

PARTIAL CREDIT RULES:
- Exact match = 100% of points for that qualification
- Close match (e.g., 9 years when 10+ required, related certification) = 90-95% of points
- Transferable skill (e.g., fintech ops when data center ops required) = 60-80% of points based on relevance
- Related but not direct (e.g., AI infrastructure when data center infrastructure required) = 60-70% of points
- Missing entirely = 0% of points

SCORE INTERPRETATION:
- 90-100%: Excellent Match - Meets all/nearly all required + strong on preferred
- 80-89%: Strong Match - Meets all required, some preferred
- 70-79%: Good Match - Meets most required, competitive candidate
- 60-69%: Fair Match - Meets minimum required, notable gaps
- Below 60%: Poor Match - Missing critical requirements

IMPORTANT: This is a TAILORED RESUME, not the original profile. It should score EQUAL OR HIGHER than the original profile because it's optimized for this job. Be generous with transferable skills and related experience.

Job Description:
${currentJobDescription}

Tailored Resume:
${resumeText}

CRITICAL: Respond with ONLY valid JSON, no other text. Use this exact format:
{
    "matchPercentage": 85,
    "matchLabel": "Strong Match",
    "keywordsAdded": 15,
    "atsCompatible": true,
    "bulletMetrics": 80,
    "improvementAreas": ["area1", "area2"]
}`;

                const response = await callClaudeAPI(systemPrompt, 'Analyze this resume against the job description.');
                
                // Extract JSON from response - handle various formats
                let jsonText = response.trim();
                
                // Remove markdown code fences
                jsonText = jsonText.replace(/```json\n?/g, '');
                jsonText = jsonText.replace(/```\n?/g, '');
                
                // Find JSON object boundaries
                const firstBrace = jsonText.indexOf('{');
                const lastBrace = jsonText.lastIndexOf('}');
                
                if (firstBrace !== -1 && lastBrace !== -1) {
                    jsonText = jsonText.substring(firstBrace, lastBrace + 1);
                }
                
                return JSON.parse(jsonText);
            } catch (error) {
                console.error('Error re-analyzing resume:', error);
                console.error('Response was:', response);
                return null;
            }
        }

        function getMatchLabel(matchPercentage) {
            if (matchPercentage >= 90) return 'Excellent Match';
            if (matchPercentage >= 80) return 'Strong Match';
            if (matchPercentage >= 70) return 'Good Match';
            if (matchPercentage >= 60) return 'Fair Match';
            return 'Poor Match';
        }

        function displayMatchComparison(originalMatch, newMatch) {
            const improvement = newMatch.matchPercentage - originalMatch;
            const scoreWentDown = improvement < 0;
            
            // If score went down, show different message with choice
            if (scoreWentDown) {
                return `
                    <div style="margin: 30px 0; padding: 25px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #92400e; margin-bottom: 20px; font-size: 18px;">‚ö†Ô∏è Tailored Resume Scored Lower</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #e5e7eb;">
                                <div style="color: #6b7280; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Original Profile</div>
                                <div style="font-size: 32px; font-weight: bold; color: #667eea; margin: 10px 0;">${originalMatch}%</div>
                                <div style="color: #059669; font-weight: 600;">${getMatchLabel(originalMatch)}</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #fca5a5;">
                                <div style="color: #6b7280; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Tailored Resume</div>
                                <div style="font-size: 32px; font-weight: bold; color: #dc2626; margin: 10px 0;">${newMatch.matchPercentage}%</div>
                                <div style="color: #dc2626; font-weight: 600;">${newMatch.matchLabel} (${improvement} points)</div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h5 style="color: #059669; margin-bottom: 12px;">‚úÖ Changes Made in Tailored Resume:</h5>
                            <ul style="margin-left: 20px; color: #374151; line-height: 1.8;">
                                <li><strong>Keywords:</strong> Added ${newMatch.keywordsAdded} relevant keywords from job description</li>
                                <li><strong>Format:</strong> ${newMatch.atsCompatible ? 'ATS-friendly ‚úì' : 'Standard format'}</li>
                                <li><strong>Quantification:</strong> ${newMatch.bulletMetrics}% of bullets include metrics</li>
                            </ul>
                            <p style="color: #6b7280; font-size: 14px; margin-top: 12px; font-style: italic;">
                                Despite the lower score, the resume has better keyword optimization and formatting for ATS systems.
                            </p>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 8px;">
                            <h5 style="color: #92400e; margin-bottom: 12px;">Which version would you like to use?</h5>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 15px;">
                                <button class="btn-primary" onclick="keepTailoredResume()" style="flex: 1; min-width: 180px;">
                                    Use Tailored Resume
                                    <div style="font-size: 11px; font-weight: normal; margin-top: 4px; opacity: 0.9;">Better ATS compatibility</div>
                                </button>
                                <button class="btn-secondary" onclick="regenerateResume()" style="flex: 1; min-width: 180px;">
                                    Regenerate Resume
                                    <div style="font-size: 11px; font-weight: normal; margin-top: 4px;">Try different approach</div>
                                </button>
                                <button class="btn-secondary" onclick="showSection('job-analysis-section')" style="flex: 1; min-width: 180px;">
                                    Back to Analysis
                                    <div style="font-size: 11px; font-weight: normal; margin-top: 4px;">Add more context</div>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Normal case: score improved or stayed same
            const improvementColor = improvement > 0 ? '#059669' : '#6b7280';
            
            return `
                <div style="margin: 30px 0; padding: 25px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h4 style="color: #667eea; margin-bottom: 20px; font-size: 18px;">üìä Match Score Comparison</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #e5e7eb;">
                            <div style="color: #6b7280; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Original Profile</div>
                            <div style="font-size: 32px; font-weight: bold; color: #667eea; margin: 10px 0;">${originalMatch}%</div>
                            <div style="color: #059669; font-weight: 600;">${getMatchLabel(originalMatch)}</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #e5e7eb;">
                            <div style="color: #6b7280; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Improvement</div>
                            <div style="font-size: 32px; font-weight: bold; color: ${improvementColor}; margin: 10px 0;">${improvement > 0 ? '+' : ''}${improvement}</div>
                            <div style="color: #6b7280; font-size: 14px;">points</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #e5e7eb;">
                            <div style="color: #6b7280; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Tailored Resume</div>
                            <div style="font-size: 32px; font-weight: bold; color: #059669; margin: 10px 0;">${newMatch.matchPercentage}%</div>
                            <div style="color: #059669; font-weight: 600;">${newMatch.matchLabel}</div>
                        </div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #d1fae5;">
                        <h5 style="color: #059669; margin-bottom: 12px;">‚úÖ ATS Compatibility Check</h5>
                        <ul style="margin-left: 20px; color: #374151; line-height: 1.8;">
                            <li><strong>Keywords Added:</strong> ${newMatch.keywordsAdded} relevant keywords from job description</li>
                            <li><strong>Format:</strong> ${newMatch.atsCompatible ? 'ATS-friendly ‚úì' : 'Needs adjustment ‚ö†Ô∏è'}</li>
                            <li><strong>Quantification:</strong> ${newMatch.bulletMetrics}% of bullets include metrics</li>
                            ${improvement > 0 ? '<li><strong>Status:</strong> Significantly improved match! üéâ</li>' : ''}
                        </ul>
                    </div>
                </div>
            `;
        }

        function keepTailoredResume() {
            // User chose to use the tailored resume despite lower score
            // Replace the warning with a confirmation message
            const warningBox = document.querySelector('[style*="border-left: 4px solid #f59e0b"]');
            if (warningBox) {
                warningBox.innerHTML = `
                    <div style="background: #d1fae5; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚úì</div>
                        <strong style="color: #059669; font-size: 18px;">Using Tailored Resume</strong>
                        <p style="margin: 12px 0 0 0; color: #047857;">
                            You can download it below or generate a cover letter.
                        </p>
                    </div>
                `;
                // Scroll to resume
                warningBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function regenerateResume() {
            // Scroll to gap-addressing box so user can add context
            const gapBox = document.getElementById('gap-context');
            if (gapBox) {
                gapBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                gapBox.focus();
                
                // Add a helpful message
                const analysisSection = document.getElementById('job-analysis-section');
                if (analysisSection) {
                    const existingTip = analysisSection.querySelector('.regenerate-tip');
                    if (!existingTip) {
                        const tip = document.createElement('div');
                        tip.className = 'regenerate-tip';
                        tip.style.cssText = 'background: #dbeafe; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #3b82f6;';
                        tip.innerHTML = `
                            <strong style="color: #1e40af;">üí° Tip:</strong>
                            <span style="color: #1e3a8a;">
                                Use the gap-addressing box above to add context about qualifications not fully captured.
                                Then click "Generate Resume" again.
                            </span>
                        `;
                        gapBox.parentElement.appendChild(tip);
                        
                        // Remove tip after 10 seconds
                        setTimeout(() => tip.remove(), 10000);
                    }
                }
            } else {
                // Fallback - just show analysis section
                showSection('job-analysis-section');
            }
        }

        async function generateResume() {
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating tailored resume...</p></div>';
            showSection('results-section');

            try {
                // Get gap-addressing context if provided
                const gapContext = document.getElementById('gap-context')?.value || '';
                
                // Create profile copy with conditional location
                const profileForResume = {...profileData};
                if (!shouldIncludeLocation()) {
                    profileForResume.contact = {...profileForResume.contact, location: ''};
                }
                
                const systemPrompt = `Generate a detailed, metric-heavy professional resume tailored to this job. Use specific accomplishments from the candidate's profile, not generic statements.

Candidate Profile:
${JSON.stringify(profileForResume, null, 2)}

Job Analysis:
${JSON.stringify(currentAnalysis, null, 2)}

CRITICAL REQUIREMENTS:

${gapContext ? `Gap-Addressing Context (incorporate naturally into resume):
${gapContext}
` : ''}

1. BULLET COUNT PER JOB:
   - Most recent role: 5-7 bullets with extensive detail
   - Previous 2-3 roles: 4-5 bullets each
   - Older roles: 2-3 bullets
   
2. QUANTIFICATION (NON-NEGOTIABLE):
   - At least 70% of bullets MUST include specific metrics, numbers, percentages, or dollar amounts
   - Use exact figures from the profile (e.g., "99% reduction", "24% to 100%", "$150-250K savings", "20+ initiatives")
   - Include before/after comparisons where available
   - Quantify scope (number of departments, states, team members, projects, etc.)

3. SPECIFICITY OVER GENERIC:
   - Use actual tool/system names (e.g., "Rovo agents", "Salesforce", "Jira")
   - Include specific projects and initiatives by name
   - Mention concrete deliverables (e.g., "11-session training series", "customer journey mapping framework")
   - Show clear outcomes and impact

4. STRUCTURE:
   - Lead with action verb
   - Include specific achievement or project
   - Add quantified impact or outcome
   - Example: "Built AI-powered Rovo agents that reduced assessment time by 99%, delivering $150K+ in annual efficiency gains"

5. LENGTH LIMIT:
   - Maximum 2 pages
   - Balance detail with conciseness
   - Each bullet should be 1-2 lines maximum

6. TONE:
   - Professional and confident but natural
   - Avoid AI clich√©s: "spearheaded", "game-changing", "synergy", "rockstar"
   - Avoid excessive enthusiasm or corporate buzzwords
   - Use clear, direct language
   - PUNCTUATION: Use simple formatting - avoid em dashes (‚Äî), limit semicolons, use periods and commas

7. PULL FROM PROFILE:
   - Use specific achievements mentioned in work history
   - Include relevant certifications and training
   - Reference actual projects, systems, and outcomes from their experience
   - Don't invent metrics - use what's provided

FORMAT: Use markdown with clear sections (Professional Summary, Core Competencies, Professional Experience, Education/Certifications). Include company name, location, and dates for each role.`;

                const resume = await callClaudeAPI(systemPrompt, `Job Description:\n${currentJobDescription}`);
                
                // Store for DOCX download
                currentResumeText = resume;
                
                // Save to generated files
                addGeneratedFile('resume', currentAnalysis.jobTitle, resume);
                
                // Re-analyze with generated resume
                const newAnalysis = await reAnalyzeWithResume(resume);
                const comparisonHtml = newAnalysis ? displayMatchComparison(currentAnalysis.matchScore, newAnalysis) : '';
                
                resultsContent.innerHTML = `
                    <h3>Your Tailored Resume</h3>
                    ${comparisonHtml}
                    <div class="document-output">${resume}</div>
                    <div class="button-group" style="margin-top: 24px;">
                        <button class="btn-secondary" onclick="copyToClipboard(\`${resume.replace(/[`]/g, '\\`')}\`)">Copy Text</button>
                        <button class="btn-primary" onclick="downloadResumeAsDOCX()">Download as DOCX</button>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating resume:', error);
                resultsContent.innerHTML = `<div class="alert alert-danger">Error generating resume. Please try again.</div>`;
            }
        }

        async function generateCoverLetter() {
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating cover letter...</p></div>';
            showSection('results-section');

            try {
                // Create profile copy with conditional location
                const profileForCover = {...profileData};
                if (!shouldIncludeLocation()) {
                    profileForCover.contact = {...profileForCover.contact, location: ''};
                }
                
                const systemPrompt = `You are writing a cover letter on behalf of a real person. This must sound like it was written by the candidate themselves, not an AI.

Candidate Profile:
${JSON.stringify(profileForCover, null, 2)}

Job Analysis:
${JSON.stringify(currentAnalysis, null, 2)}

CRITICAL - ELIMINATE ALL AI TELLS:

BANNED PHRASES (never use these):
- "I am writing to express my interest"
- "I am excited to apply"
- "I believe I would be a great fit"
- "proven track record"
- "dynamic professional"
- "leverage my experience"
- "drive results"
- "passion for"
- "thrilled to"
- "I am confident that"
- Any variation of "delighted," "thrilled," or excessive enthusiasm

BANNED PUNCTUATION:
- Em dashes (‚Äî) - Maximum ONE per letter if absolutely necessary, prefer commas or periods
- Semicolons - Use periods instead for more natural writing
- Excessive ellipses (...) - Avoid entirely unless quoting

WRITING RULES:
1. Start directly - skip the "I'm writing because..." intro
2. Use short, punchy sentences mixed with longer ones (vary rhythm)
3. Include 1-2 minor imperfections (contractions, starting sentences with "And" or "But")
4. Be specific with numbers and examples from their experience
5. Sound confident but not arrogant - use "I've" instead of "I have"
6. Write like you're emailing a colleague, not giving a speech
7. Use industry-specific terminology naturally
8. NO buzzwords or jargon unless the job description uses them
9. Show personality - add one human touch (but stay professional)
10. End with action, not "I look forward to hearing from you"

STRUCTURE (3 paragraphs max):
1. Hook (2-3 sentences): Why this role makes sense for you right now - be specific
2. Proof (3-5 sentences): 2-3 concrete examples with metrics
3. Close (2 sentences): Next step or availability

TONE: Professional but conversational. Confident but humble. Specific but concise.

Generate the cover letter now:`;

                const coverLetter = await callClaudeAPI(systemPrompt, `Job Description:\n${currentJobDescription}`);
                
                // Store for DOCX download
                currentCoverLetterText = coverLetter;
                
                // Save to generated files
                addGeneratedFile('coverLetter', currentAnalysis.jobTitle, coverLetter);
                
                resultsContent.innerHTML = `
                    <h3>Your Cover Letter</h3>
                    <div class="document-output">${coverLetter}</div>
                    <div class="button-group" style="margin-top: 24px;">
                        <button class="btn-secondary" onclick="copyToClipboard(\`${coverLetter.replace(/[`]/g, '\\`')}\`)">Copy Text</button>
                        <button class="btn-primary" onclick="downloadCoverLetterAsDOCX()">Download as DOCX</button>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating cover letter:', error);
                resultsContent.innerHTML = `<div class="alert alert-danger">Error generating cover letter. Please try again.</div>`;
            }
        }

        async function downloadResumeAsDOCX() {
            const documentOutput = document.querySelector('#results-section .document-output');
            if (!documentOutput) {
                alert('No resume found to download. Please generate a resume first.');
                return;
            }
            
            const resumeText = documentOutput.textContent;
            console.log('First 200 chars:', resumeText.substring(0, 200));
            console.log('Contains newlines:', resumeText.includes('\n'));
            console.log('Contains **:', resumeText.includes('**'));
            console.log('Contains ##:', resumeText.includes('##'));
            console.log('=== END DEBUG ===');
            
            try {
                if (typeof JSZip === 'undefined') {
                    alert('Required library not loaded. Try refreshing the page.\n\nAlternative: Use "Copy Text" button and paste into Word.');
                    return;
                }

                const zip = new JSZip();
                
                zip.file('[Content_Types].xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`);
                
                zip.folder('_rels').file('.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`);
                
                const wordFolder = zip.folder('word');
                wordFolder.folder('_rels').file('document.xml.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
</Relationships>`);
                
                const HEADER_SPACING_BEFORE = 120;
                const JOB_SECTION_SPACING_AFTER = 80;
                
                const lines = resumeText.split('\n').filter(l => {
                    const t = l.trim();
                    return t && !/^[-*_]{3,}$/.test(t);
                });
                
                const paragraphs = lines.map((line, index) => {
                    let trimmed = line.trim();
                    
                    // Strip leading separators like "---## Header" ‚Üí "## Header"
                    trimmed = trimmed.replace(/^[-*_]{3,}\s*/, '');
                    
                    const headerMatch = trimmed.match(/^(#{1,6})\s+(.+)$/);
                    let headerLevel = 0;
                    if (headerMatch) {
                        headerLevel = headerMatch[1].length;
                        trimmed = headerMatch[2];
                    }
                    
                    const cleanLine = trimmed.replace(/\*\*/g, '');
                    const isAllCaps = cleanLine === cleanLine.toUpperCase() && cleanLine.length > 2;
                    const isHeader = headerLevel > 0 || isAllCaps;
                    
                    const isBullet = /^[-‚Ä¢]\s/.test(trimmed);
                    
                    let isLastBulletInSection = false;
                    if (isBullet && index < lines.length - 1) {
                        const nextLine = lines[index + 1].trim();
                        const nextIsBullet = /^[-‚Ä¢]\s/.test(nextLine);
                        if (!nextIsBullet) {
                            const hasBold = /\*\*/.test(nextLine);
                            if (hasBold) {
                                isLastBulletInSection = true;
                            }
                        }
                    }
                    
                    const parts = [];
                    const boldRegex = /\*\*(.+?)\*\*/g;
                    let lastIndex = 0;
                    let match;
                    
                    while ((match = boldRegex.exec(trimmed)) !== null) {
                        if (match.index > lastIndex) {
                            const beforeText = trimmed.substring(lastIndex, match.index);
                            if (beforeText) {
                                parts.push({ text: beforeText, bold: isHeader });
                            }
                        }
                        parts.push({ text: match[1], bold: true });
                        lastIndex = match.index + match[0].length;
                    }
                    
                    if (lastIndex < trimmed.length) {
                        const remainingText = trimmed.substring(lastIndex);
                        if (remainingText) {
                            parts.push({ text: remainingText, bold: isHeader });
                        }
                    }
                    
                    if (parts.length === 0) {
                        parts.push({ text: trimmed, bold: isHeader });
                    }
                    
                    const runs = parts.map(part => {
                        const escaped = part.text
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&apos;');
                        
                        const fontSize = isHeader ? 28 : 22;
                        const isBold = part.bold;
                        
                        return `<w:r><w:rPr><w:sz w:val="${fontSize}"/>${isBold ? '<w:b/>' : ''}</w:rPr><w:t xml:space="preserve">${escaped}</w:t></w:r>`;
                    }).join('');
                    
                    let spacingAfter = 0;
                    if (isLastBulletInSection) {
                        spacingAfter = JOB_SECTION_SPACING_AFTER;
                    }
                    const spacingBefore = isHeader ? HEADER_SPACING_BEFORE : 0;
                    
                    return `<w:p><w:pPr><w:spacing w:after="${spacingAfter}" w:before="${spacingBefore}"/></w:pPr>${runs}</w:p>`;
                }).join('');
                
                wordFolder.file('document.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:body>
    ${paragraphs}
  </w:body>
</w:document>`);
                
                const blob = await zip.generateAsync({type: 'blob'});
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${profileData.contact.name.replace(/\s+/g, '_')}_Resume.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('DOCX Error:', error);
                alert(`Error creating DOCX: ${error.message}\n\nPlease use "Copy Text" button instead and paste into Word.`);
            }
        }

        async function downloadCoverLetterAsDOCX() {
            const documentOutput = document.querySelector('#results-section .document-output');
            if (!documentOutput) {
                alert('No cover letter found to download. Please generate a cover letter first.');
                return;
            }
            
            const coverLetterText = documentOutput.textContent;
            
            try {
                if (typeof JSZip === 'undefined') {
                    alert('Required library not loaded. Try refreshing the page.\n\nAlternative: Use "Copy Text" button and paste into Word.');
                    return;
                }

                const zip = new JSZip();
                
                zip.file('[Content_Types].xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`);
                
                zip.folder('_rels').file('.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`);
                
                const wordFolder = zip.folder('word');
                wordFolder.folder('_rels').file('document.xml.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
</Relationships>`);
                
                const textParagraphs = coverLetterText.split('\n\n').filter(p => p.trim() && !/^[-*_]{3,}$/.test(p.trim()));
                const xmlParagraphs = textParagraphs.map(para => {
                    const trimmed = para.trim();
                    
                    const parts = [];
                    const boldRegex = /\*\*(.+?)\*\*/g;
                    let lastIndex = 0;
                    let match;
                    
                    while ((match = boldRegex.exec(trimmed)) !== null) {
                        if (match.index > lastIndex) {
                            const beforeText = trimmed.substring(lastIndex, match.index);
                            if (beforeText) {
                                parts.push({ text: beforeText, bold: false });
                            }
                        }
                        parts.push({ text: match[1], bold: true });
                        lastIndex = match.index + match[0].length;
                    }
                    
                    if (lastIndex < trimmed.length) {
                        const remainingText = trimmed.substring(lastIndex);
                        if (remainingText) {
                            parts.push({ text: remainingText, bold: false });
                        }
                    }
                    
                    if (parts.length === 0) {
                        parts.push({ text: trimmed, bold: false });
                    }
                    
                    const runs = parts.map(part => {
                        const escaped = part.text
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&apos;');
                        
                        return `<w:r><w:rPr><w:sz w:val="22"/>${part.bold ? '<w:b/>' : ''}</w:rPr><w:t xml:space="preserve">${escaped}</w:t></w:r>`;
                    }).join('');
                    
                    return `<w:p><w:pPr><w:spacing w:after="240"/></w:pPr>${runs}</w:p>`;
                }).join('');
                
                wordFolder.file('document.xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:body>
    ${xmlParagraphs}
  </w:body>
</w:document>`);
                
                const blob = await zip.generateAsync({type: 'blob'});
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${profileData.contact.name.replace(/\s+/g, '_')}_CoverLetter.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('DOCX Error:', error);
                alert(`Error creating DOCX: ${error.message}\n\nPlease use "Copy Text" button instead and paste into Word.`);
            }
        }
    </script>
        </main>
    </div>
</body>
</html>